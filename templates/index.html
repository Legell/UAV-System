<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ú–æ–Ω–∏—Ç–æ—Ä –ë–í–° - ArduPilot</title>
  <link rel="stylesheet" href="/static/style.css">

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>
</head>
<body>
  <div id="map"></div>

  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">–ë–í–° / UAVs - ArduPilot</div>
      <button class="refresh-btn" onclick="refreshUAVs()">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div id="uavList" class="uav-list">
      {% for uav in uavs %}
      <div class="uav-item" data-uav-id="{{ uav.id }}" data-lat="{{ uav.lat }}" data-lon="{{ uav.lon }}">
        <div class="uav-item-top">
          <span>{{ uav.name }}</span>
          <span class="status {{ 'online' if uav.status == 'online' else 'offline' }}">
            {{ uav.status }}
          </span>
        </div>
        <div class="small">
          {{ '%.5f'|format(uav.lat) }}, {{ '%.5f'|format(uav.lon) }}
        </div>
        <div class="uav-info">
          –í—ã—Å–æ—Ç–∞: {{ '%.1f'|format(uav.alt) }} m |
          –ö—É—Ä—Å: {{ uav.heading }}¬∞ |
          –°–∫–æ—Ä–æ—Å—Ç—å: {{ '%.1f'|format(uav.ground_speed) }} m/s
        </div>
        <div class="uav-battery">
          {% set bp = uav.battery_percent %}
          {% if bp is not none and bp >= 0 %}
            {% set cls = 'battery-high' %}
            {% if bp < 20 %}
              {% set cls = 'battery-low' %}
            {% elif bp < 50 %}
              {% set cls = 'battery-medium' %}
            {% endif %}
            <div class="battery-bar">
              <div class="battery-fill {{ cls }}" style="width: {{ bp if bp > 5 else 5 }}%;"></div>
            </div>
            <span class="battery-label">üîã {{ bp }}%</span>
          {% else %}
            <span class="battery-label battery-unknown">üîã ‚Äî</span>
          {% endif %}
        </div>
      </div>
      {% else %}
      <div class="no-uavs">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ë–í–°. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–º—É–ª—è—Ç–æ—Ä / –ë–í–° —Å MAVProxy.</div>
      {% endfor %}
    </div>

    <div class="section">
      <div class="section-title">–ü–æ–≥–æ–¥–∞</div>
      <div id="weatherBox" class="weather-box small">–í—ã–±–µ—Ä–∏—Ç–µ –ë–í–°</div>
    </div>

    <div class="section">
      <div class="section-title">–ú–∏—Å—Å–∏—è</div>
      <div id="missionBox" class="small">
        {% if first_mission %}
          {% for item in first_mission %}
            <div class="mission-item">
              <b>#{{ item.seq }}</b> {{ item.command }}
              <div class="small">{{ item.params }}</div>
            </div>
          {% endfor %}
        {% else %}
          –ú–∏—Å—Å–∏—è –ø—É—Å—Ç–∞—è
        {% endif %}
      </div>
      <div class="mission-actions">
        <button id="btnStartMission" class="btn btn-primary" disabled>–°—Ç–∞—Ä—Ç –º–∏—Å—Å–∏–∏</button>
        <button id="btnStopMission" class="btn btn-secondary" disabled>–°—Ç–æ–ø</button>
      </div>
      <div id="missionStatus" class="small mission-status"></div>
    </div>

    <div class="section">
      <div class="section-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∏—Å—Å–∏—é (.plan / JSON)</div>
      <input type="file" id="missionFile" accept=".plan,application/json">
      <button id="uploadBtn" class="btn btn-outline">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <div id="uploadStatus" class="small"></div>
    </div>
  </div>

<script>
  const UAVS = {{ uavs|tojson }};

  let map = L.map('map').setView([56.0, 37.0], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  const markers = {};
  let currentUavId = UAVS.length ? UAVS[0].id : null;
  let missionPolyline = null;

  function makeIcon(uav) {
    const offline = uav.status !== 'online';
    const borderColor = offline ? '#dc2626' : '#22c55e';
    const animation = offline ? 'none' : 'pulseGreen 2s infinite';

    const uavNumber = uav.port - 219;
    const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
    const bgColor = colors[(uavNumber - 1) % colors.length];

    return L.divIcon({
      className: 'uav-marker',
      html: `<div style="
        width:48px;
        height:48px;
        border:3px solid ${borderColor};
        border-radius:50%;
        background:${bgColor};
        color:white;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:16px;
        font-weight:bold;
        animation:${animation};
        transform:rotate(${uav.heading || 0}deg);
      ">${uavNumber}</div>`,
      iconSize: [48, 48],
      iconAnchor: [24, 24]
    });
  }

  function updateUAVsList(uavs) {
    const uavListElement = document.getElementById('uavList');
    uavListElement.innerHTML = '';

    if (uavs.length === 0) {
      uavListElement.innerHTML = '<div class="no-uavs">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ë–í–°.</div>';
      return;
    }

    uavs.forEach(uav => {
      const uavItem = document.createElement('div');
      uavItem.className = 'uav-item';
      uavItem.dataset.uavId = uav.id;
      uavItem.dataset.lat = uav.lat;
      uavItem.dataset.lon = uav.lon;

      const bp = (uav.battery_percent != null && uav.battery_percent >= 0)
        ? uav.battery_percent
        : null;

      let batteryClass = 'battery-unknown';
      if (bp !== null) {
        if (bp < 20) batteryClass = 'battery-low';
        else if (bp < 50) batteryClass = 'battery-medium';
        else batteryClass = 'battery-high';
      }
      const width = bp !== null ? Math.max(5, Math.min(100, bp)) : 0;

      uavItem.innerHTML = `
        <div class="uav-item-top">
          <span>${uav.name}</span>
          <span class="status ${uav.status === 'online' ? 'online' : 'offline'}">
            ${uav.status}
          </span>
        </div>
        <div class="small">
          ${uav.lat.toFixed(5)}, ${uav.lon.toFixed(5)}
        </div>
        <div class="uav-info">
          –í—ã—Å–æ—Ç–∞: ${uav.alt.toFixed(1)} m |
          –ö—É—Ä—Å: ${uav.heading}¬∞ |
          –°–∫–æ—Ä–æ—Å—Ç—å: ${uav.ground_speed.toFixed(1)} m/s
        </div>
        <div class="uav-battery">
          ${
            bp !== null
            ? `
              <div class="battery-bar">
                <div class="battery-fill ${batteryClass}" style="width:${width}%;"></div>
              </div>
              <span class="battery-label">üîã ${bp}%</span>
            `
            : `<span class="battery-label battery-unknown">üîã ‚Äî</span>`
          }
        </div>
      `;

      uavItem.addEventListener('click', () => handleUavClick(uav));
      if (currentUavId === uav.id) {
        uavItem.classList.add('active');
      }
      uavListElement.appendChild(uavItem);
    });
  }

  async function handleUavClick(uav) {
    currentUavId = uav.id;

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
    document.querySelectorAll('.uav-item').forEach(item => {
      item.classList.toggle('active', item.dataset.uavId === uav.id);
    });

    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
    map.setView([uav.lat, uav.lon], 16);

    await loadMission(uav.id);
    await loadWeather(uav.lat, uav.lon);
  }

  async function loadMission(uavId) {
    try {
      const res = await fetch(`/uavs/${uavId}/mission`);
      const data = await res.json();
      const box = document.getElementById('missionBox');
      const btnStart = document.getElementById('btnStartMission');
      const btnStop = document.getElementById('btnStopMission');

      box.innerHTML = '';
      let points = [];

      if (!data.items || data.items.length === 0) {
        box.innerHTML = '–ú–∏—Å—Å–∏—è –ø—É—Å—Ç–∞—è';
        btnStart.disabled = true;
        btnStop.disabled = true;
      } else {
        data.items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'mission-item';
          div.innerHTML = `
            <b>#${item.seq}</b> CMD ${item.command}
            <div class="small">${JSON.stringify(item.params)}</div>
          `;
          box.appendChild(div);

          if (item.lat != null && item.lon != null) {
            points.push([item.lat, item.lon]);
          }
        });

        btnStart.disabled = false;
        btnStop.disabled = false;
      }

      drawMissionPolyline(points);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏—Å—Å–∏–∏:', error);
    }
  }

  function drawMissionPolyline(points) {
    if (missionPolyline) {
      map.removeLayer(missionPolyline);
      missionPolyline = null;
    }
    if (!points || !points.length) return;

    missionPolyline = L.polyline(points, {
      color: '#38bdf8',
      weight: 3,
      dashArray: '4'
    }).addTo(map);

    map.fitBounds(missionPolyline.getBounds().pad(0.2));
  }

  async function loadWeather(lat, lon) {
    try {
      const wres = await fetch(`/weather?lat=${lat}&lon=${lon}`);
      const wdata = await wres.json();
      const wbox = document.getElementById('weatherBox');

      if (wdata.error) {
        wbox.innerHTML = `<div style="color: #f97373;">–û—à–∏–±–∫–∞: ${wdata.error}</div>`;
      } else {
        wbox.innerHTML = `
          <div><b>${wdata.name}</b></div>
          <div>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${wdata.temp} ¬∞C</div>
          <div>–ü–æ–≥–æ–¥–∞: ${wdata.description}</div>
          <div>–í–µ—Ç–µ—Ä: ${wdata.wind_speed} –º/—Å</div>
        `;
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–≥–æ–¥—ã:', error);
      document.getElementById('weatherBox').innerHTML =
        '<div style="color: #f97373;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–≥–æ–¥—ã</div>';
    }
  }

  function initializeMarkers(uavs) {
    uavs.forEach(uav => {
      const marker = L.marker([uav.lat, uav.lon], {icon: makeIcon(uav)}).addTo(map);
      marker.bindPopup(popupHtml(uav));
      markers[uav.id] = marker;
    });
  }

  function popupHtml(uav) {
    const bp = (uav.battery_percent != null && uav.battery_percent >= 0)
      ? `${uav.battery_percent}%`
      : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
    return `
      <b>${uav.name}</b><br>
      –°—Ç–∞—Ç—É—Å: ${uav.status}<br>
      –ü–æ—Ä—Ç: ${uav.port}<br>
      –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${uav.lat.toFixed(5)}, ${uav.lon.toFixed(5)}<br>
      –í—ã—Å–æ—Ç–∞: ${uav.alt.toFixed(1)} m<br>
      –ö—É—Ä—Å: ${uav.heading}¬∞<br>
      –°–∫–æ—Ä–æ—Å—Ç—å: ${uav.ground_speed.toFixed(1)} m/s<br>
      –ë–∞—Ç–∞—Ä–µ—è: ${bp}
    `;
  }

  async function updateUAVsData() {
    try {
      const response = await fetch('/uavs');
      const uavs = await response.json();

      updateUAVsList(uavs);

      uavs.forEach(uav => {
        if (markers[uav.id]) {
          markers[uav.id].setLatLng([uav.lat, uav.lon]);
          markers[uav.id].setIcon(makeIcon(uav));
          markers[uav.id].setPopupContent(popupHtml(uav));
        } else {
          const marker = L.marker([uav.lat, uav.lon], {icon: makeIcon(uav)}).addTo(map);
          marker.bindPopup(popupHtml(uav));
          markers[uav.id] = marker;
        }
      });

      const currentUav = currentUavId && uavs.find(u => u.id === currentUavId);
      if (currentUav) {
        await loadWeather(currentUav.lat, currentUav.lon);
      }

      const currentIds = uavs.map(u => u.id);
      Object.keys(markers).forEach(id => {
        if (!currentIds.includes(id)) {
          map.removeLayer(markers[id]);
          delete markers[id];
        }
      });

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
    }
  }

  async function refreshUAVs() {
    try {
      const response = await fetch('/refresh_uavs');
      await response.json();
      await updateUAVsData();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
    }
  }

  async function disconnectUAV(uavId) {
    try {
      const response = await fetch(`/uavs/${uavId}/disconnect`, {method: 'POST'});
      const result = await response.json();
      console.log('–ë–í–° –æ—Ç–∫–ª—é—á–µ–Ω:', result);
      await updateUAVsData();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è:', error);
    }
  }

  document.getElementById('uploadBtn').addEventListener('click', async () => {
    const fileInput = document.getElementById('missionFile');
    const statusEl = document.getElementById('uploadStatus');

    if (!currentUavId) {
      statusEl.innerText = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ë–í–°';
      return;
    }
    if (!fileInput.files.length) {
      statusEl.innerText = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –º–∏—Å—Å–∏–∏ (.plan / .json)';
      return;
    }

    const fd = new FormData();
    fd.append('file', fileInput.files[0]);

    statusEl.innerText = '–ó–∞–≥—Ä—É–∂–∞–µ–º –º–∏—Å—Å–∏—é...';

    try {
      const res = await fetch(`/uavs/${currentUavId}/mission/upload`, {
        method: 'POST',
        body: fd,
      });
      const data = await res.json();
      if (!res.ok) {
        statusEl.innerText = '–û—à–∏–±–∫–∞: ' + (data.error || res.statusText);
        return;
      }

      statusEl.innerText = '–ú–∏—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞';
      await loadMission(currentUavId);
      if (data.waypoints && data.waypoints.length) {
        drawMissionPolyline(data.waypoints);
      }
    } catch (e) {
      console.error(e);
      statusEl.innerText = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ';
    }
  });

  document.getElementById('btnStartMission').addEventListener('click', async () => {
    if (!currentUavId) return;
    const statusEl = document.getElementById('missionStatus');
    statusEl.innerText = '–û—Ç–ø—Ä–∞–≤–∫–∞ –º–∏—Å—Å–∏–∏ –Ω–∞ –±–æ—Ä—Ç...';

    try {
      const res = await fetch(`/uavs/${currentUavId}/mission/start`, {
        method: 'POST'
      });
      const data = await res.json();
      if (!res.ok) {
        statusEl.innerText = '–û—à–∏–±–∫–∞: ' + (data.error || res.statusText);
        return;
      }
      statusEl.innerText = '–ú–∏—Å—Å–∏—è –∑–∞–ø—É—â–µ–Ω–∞';
    } catch (e) {
      console.error(e);
      statusEl.innerText = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –º–∏—Å—Å–∏–∏';
    }
  });

  document.getElementById('btnStopMission').addEventListener('click', async () => {
    if (!currentUavId) return;
    const statusEl = document.getElementById('missionStatus');
    statusEl.innerText = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏—Å—Å–∏–∏...';

    try {
      const res = await fetch(`/uavs/${currentUavId}/mission/stop`, {
        method: 'POST'
      });
      const data = await res.json();
      if (!res.ok) {
        statusEl.innerText = '–û—à–∏–±–∫–∞: ' + (data.error || res.statusText);
        return;
      }
      statusEl.innerText = '–ú–∏—Å—Å–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (—Ä–µ–∂–∏–º LOITER/LOITER_UNLIM)';
    } catch (e) {
      console.error(e);
      statusEl.innerText = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –º–∏—Å—Å–∏–∏';
    }
  });

  function initialize() {
    initializeMarkers(UAVS);
    updateUAVsList(UAVS);

    if (UAVS.length > 0) {
      handleUavClick(UAVS[0]);
    }

    setInterval(updateUAVsData, 2000);
  }

  document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>
