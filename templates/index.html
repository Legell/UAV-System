<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ú–æ–Ω–∏—Ç–æ—Ä –ë–í–° - ArduPilot</title>
  <link rel="stylesheet" href="/static/style.css">

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>
</head>
<body>
  <div id="map"></div>

  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">–ë–í–° / UAVs - ArduPilot</div>
      <button class="refresh-btn" onclick="refreshUAVs()">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div id="uavList" class="uav-list">
      {% for uav in uavs %}
      <div class="uav-item" data-uav-id="{{ uav.id }}" data-lat="{{ uav.lat }}" data-lon="{{ uav.lon }}">
        <div class="uav-item-top">
          <span>{{ uav.name }}</span>
          <span class="status {{ 'online' if uav.status == 'online' else 'offline' }}">
            {{ uav.status }}
          </span>
        </div>
        <div class="small">
          {{ '%.5f'|format(uav.lat) }}, {{ '%.5f'|format(uav.lon) }}
        </div>
        <div class="uav-info">
          –í—ã—Å–æ—Ç–∞: {{ '%.1f'|format(uav.alt) }} m |
          –ö—É—Ä—Å: {{ uav.heading }}¬∞ |
          –°–∫–æ—Ä–æ—Å—Ç—å: {{ '%.1f'|format(uav.ground_speed) }} m/s
        </div>
        <div class="uav-info small">
          –†–µ–∂–∏–º: {{ uav.mode or '‚Äî' }} |
          ARM: {{ 'ARMED' if uav.armed else 'DISARMED' }} |
          GPS: {{ uav.gps_fix }}D / {{ uav.satellites or 0 }} sat
        </div>
        <div class="uav-info small">
          Max H: {{ '%.1f'|format(uav.max_alt or 0) }} m |
          Max V: {{ '%.1f'|format(uav.max_speed or 0) }} m/s
        </div>
        <div class="uav-battery">
          {% set bp = uav.battery_percent %}
          {% if bp is not none and bp >= 0 %}
            {% set cls = 'battery-high' %}
            {% if bp < 20 %}
              {% set cls = 'battery-low' %}
            {% elif bp < 50 %}
              {% set cls = 'battery-medium' %}
            {% endif %}
            <div class="battery-bar">
              <div class="battery-fill {{ cls }}" style="width: {{ bp if bp > 5 else 5 }}%;"></div>
            </div>
            <span class="battery-label">üîã {{ bp }}%</span>
          {% else %}
            <span class="battery-label battery-unknown">üîã ‚Äî</span>
          {% endif %}
        </div>
      </div>
      {% else %}
      <div class="no-uavs">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ë–í–°. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–º—É–ª—è—Ç–æ—Ä / –ë–í–° —Å MAVProxy.</div>
      {% endfor %}
    </div>

    <div class="section">
      <div class="section-title">–ü–æ–≥–æ–¥–∞</div>
      <div id="weatherBox" class="weather-box small">–í—ã–±–µ—Ä–∏—Ç–µ –ë–í–°</div>
    </div>

    <div class="section">
      <div class="section-title">–ú–∏—Å—Å–∏—è</div>
      <div id="missionBox" class="small">
        {% if first_mission %}
          {% for item in first_mission %}
            <div class="mission-item">
              <b>#{{ item.seq }}</b> {{ item.command }}
              <div class="small">{{ item.params }}</div>
            </div>
          {% endfor %}
        {% else %}
          –ú–∏—Å—Å–∏—è –ø—É—Å—Ç–∞—è
        {% endif %}
      </div>
      <div id="missionTimeline" class="small mission-timeline"></div>
      <div class="mission-actions">
        <button id="btnStartMission" class="btn btn-primary" disabled>–°—Ç–∞—Ä—Ç –º–∏—Å—Å–∏–∏</button>
        <button id="btnStopMission" class="btn btn-secondary" disabled>–°—Ç–æ–ø</button>
      </div>
      <div id="missionStatus" class="small mission-status"></div>
      <div id="missionProgressOuter" class="mission-progress-outer">
        <div id="missionProgressInner" class="mission-progress-inner"></div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∏—Å—Å–∏—é (.plan / JSON)</div>
      <input type="file" id="missionFile" accept=".plan,application/json">
      <button id="uploadBtn" class="btn btn-outline">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <div id="uploadStatus" class="small"></div>
    </div>

    <div class="section">
      <div class="section-title">–õ–æ–≥–∏</div>
      <div id="logBox" class="log-box small">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>
    </div>
  </div>

<script>
  const UAVS = {{ uavs|tojson }};

  let map = L.map('map').setView([56.0, 37.0], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  const markers = {};
  let currentUavId = UAVS.length ? UAVS[0].id : null;

  // –±–∞–∑–æ–≤—ã–µ —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ (—Ç–æ–ª—å–∫–æ waypoints –∏–∑ –º–∏—Å—Å–∏–∏)
  let missionBasePoints = [];
  // –ø–æ–ª–∏–ª–∏–Ω–∏–∏ –¥–ª—è –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–π/–æ—Å—Ç–∞–≤—à–µ–π—Å—è —á–∞—Å—Ç–∏ –º–∏—Å—Å–∏–∏
  let missionPolylinePast = null;
  let missionPolylineFuture = null;
  // –ª–∏–Ω–∏—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è –ë–í–° –∫ –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–µ –º–∞—Ä—à—Ä—É—Ç–∞
  let missionPolylineStart = null;
  // –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ waypoint
  let missionCurrentMarker = null;
  // –∫—Ä—É–≥ –≤–æ–∫—Ä—É–≥ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ë–í–°
  let selectedUavCircle = null;

  // —Å–Ω–∏–º–æ–∫ /uavs –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å mission_status, logs –∏ —Ç.–¥.
  let lastUavsSnapshot = UAVS.slice();

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function makeIcon(uav) {
    const offline = uav.status !== 'online';
    const borderColor = offline ? '#dc2626' : '#22c55e';
    const animation = offline ? 'none' : 'pulseGreen 2s infinite';

    const uavNumber = uav.port - 219;
    const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
    const bgColor = colors[(uavNumber - 1 + colors.length) % colors.length];

    return L.divIcon({
      className: 'uav-marker',
      html: `<div style="
        width:48px;
        height:48px;
        border:3px solid ${borderColor};
        border-radius:50%;
        background:${bgColor};
        color:white;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:16px;
        font-weight:bold;
        animation:${animation};
        transform:rotate(${uav.heading || 0}deg);
      ">${uavNumber}</div>`,
      iconSize: [48, 48],
      iconAnchor: [24, 24]
    });
  }

  function gpsLabel(uav) {
    const fix = uav.gps_fix || 0;
    const sats = (uav.satellites != null ? uav.satellites : '?');
    let fixText = '–Ω–µ—Ç —Ñ–∏–∫—Å–∞';
    if (fix === 2) fixText = '2D';
    else if (fix >= 3) fixText = '3D';
    return `${fixText} / ${sats} sat`;
  }

  function updateUAVsList(uavs) {
    const uavListElement = document.getElementById('uavList');
    uavListElement.innerHTML = '';

    if (uavs.length === 0) {
      uavListElement.innerHTML = '<div class="no-uavs">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ë–í–°.</div>';
      return;
    }

    uavs.forEach(uav => {
      const uavItem = document.createElement('div');
      uavItem.className = 'uav-item';
      uavItem.dataset.uavId = uav.id;
      uavItem.dataset.lat = uav.lat;
      uavItem.dataset.lon = uav.lon;

      const bp = (uav.battery_percent != null && uav.battery_percent >= 0)
        ? uav.battery_percent
        : null;

      let batteryClass = 'battery-unknown';
      if (bp !== null) {
        if (bp < 20) batteryClass = 'battery-low';
        else if (bp < 50) batteryClass = 'battery-medium';
        else batteryClass = 'battery-high';
      }
      const width = bp !== null ? Math.max(5, Math.min(100, bp)) : 0;

      const gpsText = gpsLabel(uav);
      const mode = uav.mode || '‚Äî';
      const armedText = uav.armed ? 'ARMED' : 'DISARMED';
      const maxAlt = uav.max_alt != null ? uav.max_alt.toFixed(1) : '‚Äî';
      const maxSpeed = uav.max_speed != null ? uav.max_speed.toFixed(1) : '‚Äî';

      uavItem.innerHTML = `
        <div class="uav-item-top">
          <span>${uav.name}</span>
          <span class="status ${uav.status === 'online' ? 'online' : 'offline'}">
            ${uav.status}
          </span>
        </div>
        <div class="small">
          ${uav.lat.toFixed(5)}, ${uav.lon.toFixed(5)}
        </div>
        <div class="uav-info">
          –í—ã—Å–æ—Ç–∞: ${uav.alt.toFixed(1)} m |
          –ö—É—Ä—Å: ${uav.heading}¬∞ |
          –°–∫–æ—Ä–æ—Å—Ç—å: ${uav.ground_speed.toFixed(1)} m/s
        </div>
        <div class="uav-info small">
          –†–µ–∂–∏–º: ${mode} |
          ARM: ${armedText} |
          GPS: ${gpsText}
        </div>
        <div class="uav-info small">
          Max H: ${maxAlt} m |
          Max V: ${maxSpeed} m/s
        </div>
        <div class="uav-battery">
          ${
            bp !== null
            ? `
              <div class="battery-bar">
                <div class="battery-fill ${batteryClass}" style="width:${width}%;"></div>
              </div>
              <span class="battery-label">üîã ${bp}%</span>
            `
            : `<span class="battery-label battery-unknown">üîã ‚Äî</span>`
          }
        </div>
      `;

      uavItem.addEventListener('click', () => handleUavClick(uav));
      if (currentUavId === uav.id) {
        uavItem.classList.add('active');
      }
      uavListElement.appendChild(uavItem);
    });
  }

  function updateLogBox(uav) {
    const box = document.getElementById('logBox');
    if (!box) return;
    const logs = uav.logs || [];
    if (!logs.length) {
      box.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
      return;
    }
    box.innerHTML = logs.slice(-30).map(line =>
      `<div class="log-line">‚Ä¢ ${escapeHtml(line)}</div>`
    ).join('');
  }

  function formatEta(seconds) {
    if (!isFinite(seconds) || seconds <= 0) return '‚Äî';
    const s = Math.round(seconds);
    if (s < 60) return `${s} —Å`;
    const m = Math.floor(s / 60);
    const rem = s % 60;
    if (m < 60) {
      return rem > 0 ? `${m} –º–∏–Ω ${rem} —Å` : `${m} –º–∏–Ω`;
    }
    const h = Math.floor(m / 60);
    const rm = m % 60;
    return rm > 0 ? `${h} —á ${rm} –º–∏–Ω` : `${h} —á`;
  }

  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function computeMissionEta(uav) {
    if (!missionBasePoints || missionBasePoints.length === 0) return null;
    const speed = uav.ground_speed || 0;
    if (!speed || speed < 0.1) return null;

    const eps = 1e-7;
    if (Math.abs(uav.lat) < eps || Math.abs(uav.lon) < eps) return null;

    let seq = (uav.mission_current_seq != null ? uav.mission_current_seq : 0);
    let idx = seq - 1; // 0-–π –∏–Ω–¥–µ–∫—Å –º–∏—Å—Å–∏–∏ –Ω–∞ –±–æ—Ä—Ç—É ‚Äî –¥–æ–º, —É –Ω–∞—Å —Å–ø–∏—Å–æ–∫ –±–µ–∑ –¥–æ–º–∞
    if (idx < 0) idx = 0;
    if (idx >= missionBasePoints.length) idx = missionBasePoints.length - 1;

    const next = missionBasePoints[idx];
    let distToNext = haversine(uav.lat, uav.lon, next[0], next[1]);

    let remaining = distToNext;
    for (let i = idx; i < missionBasePoints.length - 1; i++) {
      const p1 = missionBasePoints[i];
      const p2 = missionBasePoints[i+1];
      remaining += haversine(p1[0], p1[1], p2[0], p2[1]);
    }

    return {
      etaNextSec: distToNext / speed,
      etaTotalSec: remaining / speed,
    };
  }

  function updateMissionStatusUI(uav) {
    const statusEl = document.getElementById('missionStatus');
    const btnStart = document.getElementById('btnStartMission');
    const btnStop  = document.getElementById('btnStopMission');
    const progressBar = document.getElementById('missionProgressInner');

    const mStatus = uav.mission_status || 'idle';
    const total = uav.mission_total || 0;
    const seq = (uav.mission_current_seq != null ? uav.mission_current_seq : -1);
    const humanIndex = seq >= 0 ? seq + 1 : 0;

    let text = '';
    let perc = 0;

    if (mStatus === 'idle') {
      text = '–ú–∏—Å—Å–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è';
    } else if (mStatus === 'starting') {
      text = '–ú–∏—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ –±–æ—Ä—Ç...';
    } else if (mStatus === 'running') {
      if (total > 0) {
        const clampedIdx = Math.min(humanIndex, total);
        perc = (uav.mission_progress != null)
          ? Math.round(uav.mission_progress * 100)
          : Math.round((clampedIdx / total) * 100);
        text = `–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏—Å—Å–∏–∏: —Ç–æ—á–∫–∞ ${clampedIdx} –∏–∑ ${total} (${perc}%)`;
      } else {
        text = '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏—Å—Å–∏–∏...';
      }
    } else if (mStatus === 'completed') {
      perc = 100;
      text = '–ú–∏—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
    } else if (mStatus === 'stopped') {
      text = '–ú–∏—Å—Å–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
    } else if (mStatus === 'error') {
      const phase = uav.mission_phase || '';
      text = '–û—à–∏–±–∫–∞ –º–∏—Å—Å–∏–∏' + (phase ? ` (${phase})` : '');
    } else {
      text = mStatus;
    }

    // ETA, –µ—Å–ª–∏ –º–æ–∂–µ–º –ø–æ—Å—á–∏—Ç–∞—Ç—å
    if (mStatus === 'running' || mStatus === 'starting') {
      const eta = computeMissionEta(uav);
      if (eta) {
        const etaNext = formatEta(eta.etaNextSec);
        const etaTotal = formatEta(eta.etaTotalSec);
        text += ` ¬∑ –î–æ —Å–ª–µ–¥—É—é—â–µ–π —Ç–æ—á–∫–∏: ${etaNext}, –¥–æ –∫–æ–Ω—Ü–∞ –º–∏—Å—Å–∏–∏: ${etaTotal}`;
      }
    }

    statusEl.textContent = text;

    if (progressBar) {
      const value = mStatus === 'completed' ? 100 : (perc || 0);
      const clamped = Math.max(0, Math.min(100, value));
      progressBar.style.width = clamped + '%';
    }

    const hasMission = Array.isArray(uav.mission) && uav.mission.length > 0;

    btnStart.disabled =
      !hasMission ||
      uav.status !== 'online' ||
      (mStatus === 'starting' || mStatus === 'running');

    btnStop.disabled = !(mStatus === 'starting' || mStatus === 'running');

    // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø—É–Ω–∫—Ç–∞ –º–∏—Å—Å–∏–∏ –≤ —Å–ø–∏—Å–∫–µ
    highlightCurrentMissionItem(uav);
  }

  let missionDomItems = []; // —Å–ø–∏—Å–æ–∫ DOM-—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–∏—Å—Å–∏–∏ –≤ —Ç–µ–∫—É—â–µ–º –±–æ–∫—Å–µ

  function highlightCurrentMissionItem(uav) {
    missionDomItems.forEach(el => el.classList.remove('current'));

    const seq = (uav.mission_current_seq != null ? uav.mission_current_seq : -1);
    const idx = seq - 1; // 0 ‚Äî –¥–æ–º, 1..N ‚Äî –Ω–∞—à–∏ —ç–ª–µ–º–µ–Ω—Ç—ã
    if (idx < 0 || idx >= missionDomItems.length) return;

    const el = missionDomItems[idx];
    if (el) el.classList.add('current');
  }

  function commandToLabel(cmd) {
    switch (cmd) {
      case 22: return '–í–∑–ª—ë—Ç';
      case 16: return 'WP';
      case 20: return '–ü–æ—Å–∞–¥–∫–∞';
      case 82: return 'RTL';
      default: return `CMD ${cmd}`;
    }
  }

  async function handleUavClick(uav) {
    currentUavId = uav.id;

    document.querySelectorAll('.uav-item').forEach(item => {
      item.classList.toggle('active', item.dataset.uavId === uav.id);
    });

    map.setView([uav.lat, uav.lon], 16);

    await loadMission(uav.id);
    await loadWeather(uav.lat, uav.lon);

    const current = lastUavsSnapshot.find(x => x.id === uav.id);
    if (current) {
      updateMissionStatusUI(current);
      updateLogBox(current);
    }
  }

  async function loadMission(uavId) {
    try {
      const res = await fetch(`/uavs/${uavId}/mission`);
      const data = await res.json();
      const box = document.getElementById('missionBox');
      const timelineEl = document.getElementById('missionTimeline');

      box.innerHTML = '';
      missionDomItems = [];
      missionBasePoints = [];

      if (!data.items || data.items.length === 0) {
        box.innerHTML = '–ú–∏—Å—Å–∏—è –ø—É—Å—Ç–∞—è';
        timelineEl.textContent = '';
      } else {
        const parts = [];

        data.items.forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'mission-item';
          div.innerHTML = `
            <b>#${item.seq}</b> ${commandToLabel(item.command)}
            <div class="small">${JSON.stringify(item.params)}</div>
          `;
          box.appendChild(div);
          missionDomItems.push(div);

          if (item.lat != null && item.lon != null) {
            missionBasePoints.push([item.lat, item.lon]);
          }

          parts.push(`#${item.seq} ${commandToLabel(item.command)}`);
        });

        timelineEl.textContent = '–ú–∞—Ä—à—Ä—É—Ç: ' + parts.join(' ‚Üí ');
      }

      // –ø—É—Ç—å –¥–ª—è –∫–∞—Ä—Ç—ã: –¥—Ä–æ–Ω ‚Üí –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞ ‚Üí ...
      const eps = 1e-7;
      let droneLat = null;
      let droneLon = null;

      const uav = lastUavsSnapshot.find(u => u.id === uavId);
      if (uav && Math.abs(uav.lat) > eps && Math.abs(uav.lon) > eps) {
        droneLat = uav.lat;
        droneLon = uav.lon;
      }

      drawMissionSegments(droneLat, droneLon);

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏—Å—Å–∏–∏:', error);
    }
  }

  function clearMissionLayers() {
    if (missionPolylinePast) {
      map.removeLayer(missionPolylinePast);
      missionPolylinePast = null;
    }
    if (missionPolylineFuture) {
      map.removeLayer(missionPolylineFuture);
      missionPolylineFuture = null;
    }
    if (missionPolylineStart) {
      map.removeLayer(missionPolylineStart);
      missionPolylineStart = null;
    }
    if (missionCurrentMarker) {
      map.removeLayer(missionCurrentMarker);
      missionCurrentMarker = null;
    }
  }

  function drawMissionSegments(droneLat, droneLon) {
    clearMissionLayers();

    if (!missionBasePoints || missionBasePoints.length === 0) return;

    const latlngs = [];
    const eps = 1e-7;

    // –ª–∏–Ω–∏—è –æ—Ç –¥—Ä–æ–Ω–∞ –¥–æ –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
    if (droneLat != null && droneLon != null) {
      const first = missionBasePoints[0];
      missionPolylineStart = L.polyline([[droneLat, droneLon], first], {
        color: '#64748b',
        weight: 2,
        dashArray: '4',
      }).addTo(map);
      latlngs.push([droneLat, droneLon]);
    }

    missionBasePoints.forEach(p => latlngs.push(p));

    // –¥–µ–ª–∏–º –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–π/–æ—Å—Ç–∞–≤—à–∏–π—Å—è –ø–æ mission_current_seq
    const current = lastUavsSnapshot.find(u => u.id === currentUavId);
    let idx = -1;
    if (current && typeof current.mission_current_seq === 'number') {
      idx = current.mission_current_seq - 1; // 0 ‚Äî –¥–æ–º
    }
    if (idx < -1) idx = -1;
    if (idx >= missionBasePoints.length) idx = missionBasePoints.length - 1;

    const pastPoints = [];
    const futurePoints = [];

    if (idx < 0) {
      // –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–æ
      futurePoints.push(...missionBasePoints);
    } else {
      for (let i = 0; i < missionBasePoints.length; i++) {
        if (i <= idx) pastPoints.push(missionBasePoints[i]);
        if (i >= idx) futurePoints.push(missionBasePoints[i]);
      }
    }

    if (pastPoints.length >= 2) {
      missionPolylinePast = L.polyline(pastPoints, {
        color: '#38bdf8',
        weight: 3,
      }).addTo(map);
    }
    if (futurePoints.length >= 2) {
      missionPolylineFuture = L.polyline(futurePoints, {
        color: '#64748b',
        weight: 3,
        dashArray: '4',
      }).addTo(map);
    }

    // –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ WP
    if (idx >= 0 && idx < missionBasePoints.length) {
      const p = missionBasePoints[idx];
      missionCurrentMarker = L.circleMarker(p, {
        radius: 6,
        color: '#f97316',
        fillColor: '#f97316',
        fillOpacity: 0.9,
        weight: 2,
      }).addTo(map);
    }

    if (latlngs.length) {
      map.fitBounds(L.latLngBounds(latlngs).pad(0.2));
    }
  }

  async function loadWeather(lat, lon) {
    try {
      const wres = await fetch(`/weather?lat=${lat}&lon=${lon}`);
      const wdata = await wres.json();
      const wbox = document.getElementById('weatherBox');

      if (wdata.error) {
        wbox.innerHTML = `<div style="color: #f97373;">–û—à–∏–±–∫–∞: ${wdata.error}</div>`;
      } else {
        wbox.innerHTML = `
          <div><b>${wdata.name}</b></div>
          <div>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${wdata.temp} ¬∞C</div>
          <div>–ü–æ–≥–æ–¥–∞: ${wdata.description}</div>
          <div>–í–µ—Ç–µ—Ä: ${wdata.wind_speed} –º/—Å</div>
        `;
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–≥–æ–¥—ã:', error);
      document.getElementById('weatherBox').innerHTML =
        '<div style="color: #f97373;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–≥–æ–¥—ã</div>';
    }
  }

  function initializeMarkers(uavs) {
    uavs.forEach(uav => {
      const marker = L.marker([uav.lat, uav.lon], {icon: makeIcon(uav)}).addTo(map);
      marker.bindPopup(popupHtml(uav));
      markers[uav.id] = marker;
    });
  }

  function popupHtml(uav) {
    const bp = (uav.battery_percent != null && uav.battery_percent >= 0)
      ? `${uav.battery_percent}%`
      : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
    const gpsText = gpsLabel(uav);
    const mode = uav.mode || '‚Äî';
    const armedText = uav.armed ? 'ARMED' : 'DISARMED';
    const maxAlt = uav.max_alt != null ? uav.max_alt.toFixed(1) : '‚Äî';
    const maxSpeed = uav.max_speed != null ? uav.max_speed.toFixed(1) : '‚Äî';

    return `
      <b>${uav.name}</b><br>
      –°—Ç–∞—Ç—É—Å: ${uav.status}<br>
      –ü–æ—Ä—Ç: ${uav.port}<br>
      –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${uav.lat.toFixed(5)}, ${uav.lon.toFixed(5)}<br>
      –í—ã—Å–æ—Ç–∞: ${uav.alt.toFixed(1)} m<br>
      –ö—É—Ä—Å: ${uav.heading}¬∞<br>
      –°–∫–æ—Ä–æ—Å—Ç—å: ${uav.ground_speed.toFixed(1)} m/s<br>
      –†–µ–∂–∏–º: ${mode} (${armedText})<br>
      GPS: ${gpsText}<br>
      Max H: ${maxAlt} m, Max V: ${maxSpeed} m/s<br>
      –ë–∞—Ç–∞—Ä–µ—è: ${bp}
    `;
  }

  async function updateUAVsData() {
    try {
      const response = await fetch('/uavs');
      const uavs = await response.json();

      lastUavsSnapshot = uavs.slice();

      updateUAVsList(uavs);

      uavs.forEach(uav => {
        if (markers[uav.id]) {
          markers[uav.id].setLatLng([uav.lat, uav.lon]);
          markers[uav.id].setIcon(makeIcon(uav));
          markers[uav.id].setPopupContent(popupHtml(uav));
        } else {
          const marker = L.marker([uav.lat, uav.lon], {icon: makeIcon(uav)}).addTo(map);
          marker.bindPopup(popupHtml(uav));
          markers[uav.id] = marker;
        }
      });

      const currentUav = currentUavId && uavs.find(u => u.id === currentUavId);
      if (currentUav) {
        await loadWeather(currentUav.lat, currentUav.lon);
        updateMissionStatusUI(currentUav);
        updateLogBox(currentUav);

        // –∫—Ä—É–≥ –≤–æ–∫—Ä—É–≥ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ë–í–°
        if (!selectedUavCircle) {
          selectedUavCircle = L.circle([currentUav.lat, currentUav.lon], {
            radius: 25,
            color: '#38bdf8',
            weight: 1,
            fillColor: '#38bdf8',
            fillOpacity: 0.1,
          }).addTo(map);
        } else {
          selectedUavCircle.setLatLng([currentUav.lat, currentUav.lon]);
        }

        // –æ–±–Ω–æ–≤–∏–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –º–∞—Ä—à—Ä—É—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏ –ë–í–°
        drawMissionSegments(currentUav.lat, currentUav.lon);
      } else {
        if (selectedUavCircle) {
          map.removeLayer(selectedUavCircle);
          selectedUavCircle = null;
        }
      }

      const currentIds = uavs.map(u => u.id);
      Object.keys(markers).forEach(id => {
        if (!currentIds.includes(id)) {
          map.removeLayer(markers[id]);
          delete markers[id];
        }
      });

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
    }
  }

  async function refreshUAVs() {
    try {
      const response = await fetch('/refresh_uavs');
      await response.json();
      await updateUAVsData();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
    }
  }

  async function disconnectUAV(uavId) {
    try {
      const response = await fetch(`/uavs/${uavId}/disconnect`, {method: 'POST'});
      const result = await response.json();
      console.log('–ë–í–° –æ—Ç–∫–ª—é—á–µ–Ω:', result);
      await updateUAVsData();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è:', error);
    }
  }

  document.getElementById('uploadBtn').addEventListener('click', async () => {
    const fileInput = document.getElementById('missionFile');
    const statusEl = document.getElementById('uploadStatus');

    if (!currentUavId) {
      statusEl.innerText = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ë–í–°';
      return;
    }
    if (!fileInput.files.length) {
      statusEl.innerText = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –º–∏—Å—Å–∏–∏ (.plan / .json)';
      return;
    }

    const fd = new FormData();
    fd.append('file', fileInput.files[0]);

    statusEl.innerText = '–ó–∞–≥—Ä—É–∂–∞–µ–º –º–∏—Å—Å–∏—é...';

    try {
      const res = await fetch(`/uavs/${currentUavId}/mission/upload`, {
        method: 'POST',
        body: fd,
      });
      const data = await res.json();
      if (!res.ok) {
        statusEl.innerText = '–û—à–∏–±–∫–∞: ' + (data.error || res.statusText);
        return;
      }

      statusEl.innerText = '–ú–∏—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞';
      await loadMission(currentUavId);
    } catch (e) {
      console.error(e);
      statusEl.innerText = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ';
    }
  });

  document.getElementById('btnStartMission').addEventListener('click', async () => {
    if (!currentUavId) return;
    const statusEl = document.getElementById('missionStatus');

    if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏—Å—Å–∏—é –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ë–í–°?')) {
      return;
    }

    statusEl.innerText = '–û—Ç–ø—Ä–∞–≤–∫–∞ –º–∏—Å—Å–∏–∏ –Ω–∞ –±–æ—Ä—Ç...';

    try {
      const res = await fetch(`/uavs/${currentUavId}/mission/start`, {
        method: 'POST'
      });
      const data = await res.json();
      if (!res.ok) {
        statusEl.innerText = '–û—à–∏–±–∫–∞: ' + (data.error || res.statusText);
        return;
      }
      statusEl.innerText = '–ú–∏—Å—Å–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...';
    } catch (e) {
      console.error(e);
      statusEl.innerText = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –º–∏—Å—Å–∏–∏';
    }
  });

  document.getElementById('btnStopMission').addEventListener('click', async () => {
    if (!currentUavId) return;
    const statusEl = document.getElementById('missionStatus');

    if (!confirm('–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –º–∏—Å—Å–∏—é? –ë–í–° –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è.')) {
      return;
    }

    statusEl.innerText = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏—Å—Å–∏–∏...';

    try {
      const res = await fetch(`/uavs/${currentUavId}/mission/stop`, {
        method: 'POST'
      });
      const data = await res.json();
      if (!res.ok) {
        statusEl.innerText = '–û—à–∏–±–∫–∞: ' + (data.error || res.statusText);
        return;
      }
      statusEl.innerText = '–ú–∏—Å—Å–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (—Ä–µ–∂–∏–º LOITER/LOITER_UNLIM)';
    } catch (e) {
      console.error(e);
      statusEl.innerText = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –º–∏—Å—Å–∏–∏';
    }
  });

  function initialize() {
    initializeMarkers(UAVS);
    updateUAVsList(UAVS);
    lastUavsSnapshot = UAVS.slice();

    if (UAVS.length > 0) {
      handleUavClick(UAVS[0]);
      updateMissionStatusUI(UAVS[0]);
      updateLogBox(UAVS[0]);
    }

    setInterval(updateUAVsData, 2000);
  }

  document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>
